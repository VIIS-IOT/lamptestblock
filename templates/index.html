<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testtube LAMP</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">

    <!-- Optional theme -->
    <!-- <link rel="stylesheet" href="/static/css/bootstrap-theme.min.css"> -->
    <script src="/static/js/plotly.min.js"></script>

    <style>
        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4caf50;
            /* Green */
            color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
        }

        .notification.show {
            display: block;
        }

        @font-face {
            font-family: 'Roboto';
            src: url('/static/font/poppins/Poppins-Regular.ttf') format('truetype');
            font-weight: 400;
            font-style: normal;
        }

        /* Neumorphism style variables */
        :root {
            --background: #e0e0e0;
            --foreground: #e0e0e0;
            --shadow: rgba(0, 0, 0, 0.2);
            --light-shadow: rgba(255, 255, 255, 0.7);
            --primary-color: #1a7842;
            --secondary-color: #2ecc71;
            --warning-color: #e74c3c;
            --danger-color: #e74c3c;
            --info-color: #9b59b6;
            --update-color: #50b2dc;
            --latest-image-section-color: rgba(36, 138, 181, 0.845);
        }

        body {
            padding: 20px;
            background: var(--background);
            color: #333;
            font-family: 'Poppins', sans-serif;
        }

        .section-divider {
            margin-top: 20px;
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 12px;
            background: var(--foreground);
            box-shadow: 5px 5px 10px var(--shadow),
                -5px -5px 10px var(--light-shadow);
        }

        .latest-image-section {
            margin-top: 20px;
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 12px;
            background: var(--latest-image-section-color);
            /* Apply the update color */
            box-shadow: 5px 5px 10px var(--shadow),
                -5px -5px 10px var(--light-shadow);
            color: #fff;
            /* Optional: Set text color for better contrast */
        }

        .latest-image-section {
            color: #fff;
            /* Set text color to white */
        }

        .latest-image-section h4,
        .latest-image-section span

        /* .latest-image-section th, */
        /* .latest-image-section td */
            {
            color: #fff;
            /* Ensure all text elements within the section are white */
        }

        #latestImage {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        .graph-container {
            width: 100%;
            margin-top: 20px;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
            text-align: center;
        }

        .graph {
            width: 100%;
            display: inline-block;
        }

        h2 {
            margin-top: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        h3 {
            margin-top: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        #status {
            margin-top: 20px;
            margin-bottom: 20px;
            padding: 10px;
            font-weight: bold;
            text-align: center;
            border-radius: 12px;
            background: var(--latest-image-section-color);
            /* Background color */
            color: #fff;
            /* Text color for better contrast */
            box-shadow: inset 5px 5px 10px var(--shadow),
                inset -5px -5px 10px var(--light-shadow);
        }

        .btn-group-custom button {
            margin: 5px;
            background: var(--foreground);
            border-radius: 12px;
            box-shadow: 5px 5px 10px var(--shadow),
                -5px -5px 10px var(--light-shadow);
            border: none;
            color: #333;
        }

        .btn-group-custom .btn-primary {
            background-color: var(--primary-color);
            color: #fff;
        }

        .btn-group-custom .btn-warning {
            /* background-color: var(--warning-color); */
            color: #000000;
        }

        .btn-group-custom .btn-success {
            /* background-color: var(--secondary-color); */
            color: #000000;
        }

        .btn-group-custom .btn-danger {
            background-color: var(--danger-color);
            color: #fff;
        }

        .btn-group-custom .btn-info {
            /* background-color: var(--info-color); */
            color: #000000;
        }

        .btn-group-custom button:hover {
            box-shadow: inset 5px 5px 10px var(--shadow),
                inset -5px -5px 10px var(--light-shadow);
        }

        .btn-group-custom .btn-secondary {
            background-color: var(--update-color);
            /* Set the desired background color */
            color: #fff;
            /* Set the text color for better contrast border: none;
            /* Remove the border */
            /* border-radius: 12px; */
            /* Optional: Add border radius for rounded corners */
            /* box-shadow: 5px 5px 10px var(--shadow), -5px -5px 10px var(--light-shadow); */
            /* 
            /* Optional: Add box shadow */
        }

        .btn-group-custom .btn-secondary:hover {
            box-shadow: inset 5px 5px 10px var(--shadow), inset -5px -5px 10px var(--light-shadow);
            /* Optional: Add hover effect */
        }

        .input-group-custom .col-md-3 {
            text-align: right;
        }

        .input-group-custom .col-md-9 {
            margin-bottom: 10px;
        }

        @media (max-width: 767.98px) {

            .input-group-custom .col-md-3,
            .input-group-custom .col-md-9 {
                text-align: left;
            }
        }

        .input-item {
            display: flex;
            align-items: center;
            height: 100%;
        }

        .input-item p {
            margin-bottom: 0;
        }

        .label-equal {
            flex-basis: 200px;
            text-align: right;
        }

        .form-control {
            background: var(--foreground);
            border-radius: 12px;
            border: none;
            box-shadow: inset 5px 5px 10px var(--shadow),
                inset -5px -5px 10px var(--light-shadow);
        }

        .form-control:focus {
            box-shadow: inset 5px 5px 10px var(--shadow),
                inset -5px -5px 10px var(--light-shadow);
            outline: none;
        }

        .btn {
            background: var(--foreground);
            border-radius: 12px;
            box-shadow: 5px 5px 10px var(--shadow),
                -5px -5px 10px var(--light-shadow);
            border: none;
            color: #333;
        }

        .btn:hover {
            box-shadow: inset 5px 5px 10px var(--shadow),
                inset -5px -5px 10px var(--light-shadow);
        }

        /* table {
            background: var(--foreground);
            border-radius: 12px;
            box-shadow: inset 5px 5px 10px var(--shadow),
                inset -5px -5px 10px var(--light-shadow);
        }

        th,
        td {
            text-align: center;
        } */
        table {
            width: 100%;
            background: #f0f0f0;
            /* Light grey background */
            border-radius: 12px;
            box-shadow: 5px 5px 10px var(--shadow), -5px -5px 10px var(--light-shadow);
            border-collapse: collapse;
            overflow: hidden;
        }

        th,
        td {
            padding: 12px;
            text-align: center;
            background: var(--foreground);
            box-shadow: inset 2px 2px 5px var(--shadow), inset -2px -2px 5px var(--light-shadow);
            color: #9b59b6;
        }

        th {
            font-weight: bold;
        }

        tbody tr:hover {
            background: #933535;
        }

        /* Ensure text color is applied correctly */
        /*tbody tr {
            color: purple !important;
        }*/

        h1,
        h4,
        h6 {
            color: #333;
        }

        label {
            color: #333;
            margin-bottom: 0;
        }

        img {
            border-radius: 12px;
            box-shadow: 5px 5px 10px var(--shadow),
                -5px -5px 10px var(--light-shadow);
        }

        /* Neumorphism style for labels */
        .neumorphism-label {
            background: #e0e0e0;
            border-radius: 12px;
            box-shadow: 5px 5px 10px #bebebe, -5px -5px 10px #ffffff;
            padding: 10px;
            transition: 0.3s;
        }

        .purple-text {
            color: purple !important;
            /* Use !important to ensure it overrides other styles */
        }

        /* On hover effect
        .neumorphism-label:hover {
            box-shadow: inset 5px 5px 10px #bebebe, inset -5px -5px 10px #ffffff;
        } */
    </style>

</head>

<body>
    <div class="container">
        <h1 class="mb-4 text-center">LAMP: Trích xuất giá trị màu sắc HUE từ ống nghiệm</h1>

        <!-- Button Group -->
        <div class="section-divider">
            <div id="controls" class="d-flex flex-wrap justify-content-center btn-group-custom">
                <button class="btn btn-primary mb-2 mx-1" onclick="changeState('Running', startCapture)">Bắt
                    đầu</button>
                <button class="btn btn-warning mb-2 mx-1" onclick="changeState('Pause', pauseCapture)">Tạm dừng</button>
                <button class="btn btn-success mb-2 mx-1" onclick="changeState('Resume', resumeCapture)">Tiếp
                    tục</button>
                <button class="btn btn-danger mb-2 mx-1" onclick="changeState('Reset', resetCapture)">Làm lại</button>
                <button class="btn btn-info mb-2 mx-1" onclick="changeState('Downloading CSV', downloadCSV)">Tải kết
                    quả</button>
                <button class="btn btn-info mb-2 mx-1" onclick="changeState('Downloading Image', downloadImages)">Tải
                    ảnh</button>
            </div>
        </div>

        <!-- Temperature Display and Setting -->
        <div id="temperature_values" class="mt-3">
            <div class="container-fluid">
                <div class="row align-items-center">
                    <!-- Nhiệt độ hiện tại -->
                    <div class="col-12 col-md-6 input-item">
                        <p style="font-weight: bold;">Nhiệt độ hiện tại: <span id="temp_value">-</span> °C</p>
                    </div>

                    <!-- Cài đặt giá trị mới -->
                    <div class="col-12 col-md-6 input-item d-flex align-items-center">
                        <label for="setTemperature" class="input-label" style="flex: 0 0 48%; font-weight: bold;">Cài
                            giá trị mới:</label>
                        <div class="input-group" style="flex: 1;">
                            <input type="number" id="setTemperature" class="form-control" min="0" step="1" value="25"
                                style="margin-right: 10px;">
                            <div class="input-group-append btn-group-custom">
                                <button class="btn btn-secondary btn-group-custom" onclick="setTemperature()">Cập
                                    nhật</button>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="status">Trạng thái: Chờ lệnh</div>

        <!-- Program and Temperature Settings -->
        <div class="section-divider">
            <div id="controls" class="d-flex flex-wrap justify-content-center">
                <div class="input-group mb-3"
                    style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap;">
                    <label for="programSelect" class="input-group-text neumorphism-label"
                        style="flex: 0 0 48%; max-width: 48%; text-align: right; white-space: nowrap;">Chương
                        trình:</label>
                    <select id="programSelect" class="form-select" style="flex: 1; max-width: 52%; padding: 10px; border-radius: 0px; border: none; 
                               box-shadow: 6px 6px 12px rgba(0, 0, 0, 0.1), -6px -6px 12px rgba(255, 255, 255, 0.7); 
                               background-color: #e0e0e0; min-width: 0;">
                        <option value="1">1: Làm quen quy trình</option>
                        <option value="2">2: Chạy thử mẫu</option>
                    </select>

                </div>

                <div class="input-group mb-3"
                    style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap;">
                    <label for="temperature" class="input-group-text neumorphism-label"
                        style="flex: 0 0 48%; max-width: 48%; text-align: right; white-space: nowrap;">Cài nhiệt độ
                        (C):</label>
                    <input type="number" id="temperature" class="form-control" value="65"
                        style="flex: 1; max-width: 52%;">
                </div>

                <div class="input-group mb-3"
                    style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap;">
                    <label for="checkTime" class="input-group-text neumorphism-label"
                        style="flex: 0 0 48%; max-width: 48%; text-align: right; white-space: nowrap;" hidden>Cài T1
                        (s):</label>
                    <input type="number" id="checkTime" class="form-control" value="30" style="flex: 1; max-width: 52%;"
                        hidden>
                </div>

                <div class="input-group mb-3"
                    style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap;">
                    <label for="processTime" class="input-group-text neumorphism-label"
                        style="flex: 0 0 48%; max-width: 48%; text-align: right; white-space: nowrap;">Thời gian
                        chạy (s):</label>
                    <input type="number" id="processTime" class="form-control" value="1800"
                        style="flex: 1; max-width: 52%;">
                </div>


                <!-- <button class="btn btn-primary" onclick="runProgram()">Chạy chương trình</button> -->
            </div>
        </div>

        <!-- Result Display -->
        <div class="latest-image-section">
            <!-- <div class="col-12 col-md-3" style="margin-bottom: 2rem;">
                <h4 style="text-align: center;">ẢNH CHỤP MỚI NHẤT</h4>
                <img id="latestImage" src="" alt="Latest Image" class="img-fluid" />
            </div> -->
            <div class="col-12 col-md-3 d-flex flex-column align-items-center justify-content-center w-100"
                style="margin-bottom: 2rem;">
                <h4 style="text-align: center;">ẢNH CHỤP MỚI NHẤT</h4>
                <img id="latestImage" src="./empty.jpg" alt="Latest Image" />
                <img id="hiddenImage" src="" alt="Hidden Image" style="display: none;" />
            </div>



            <div id="result">
                <h4 class="text-center font-weight-bold">Thời gian: <span id="elapsed_time"> s</span></h4>
                <h4 class="text-center font-weight-bold">Kết quả: <span id="totalResultText">Chờ lệnh...</span></h4>

                <table id="resultTable" class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Ống</th>
                            <th>Giá trị HUE</th>
                            <th>Giá trị C</th>
                            <th>Kết quả</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>

        </div>

        <!-- Plot Display -->
        <div class="section-divider">
            <div class="row">
                <div class="section-divider">
                    <div style="margin-top: 2rem;" class="col-12">
                        <h4 class="text-center">ĐỒ THỊ GIÁ TRỊ HUE</h4>
                        <div class="graph graph-container" id="graph"></div>
                    </div>
                </div>
            </div>
        </div>


        <div class="section-divider">
            <h4 class="text-center">Thiết lập WiFi mới</h4>
            <form id="wifiForm">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="ssid" class="form-label">SSID:</label>
                        <select class="form-control" id="ssid" required>
                            <!-- Options will be dynamically populated -->
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="password" class="form-label">Password:</label>
                        <input type="text" class="form-control" id="password" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Thiết lập WiFi</button>
            </form>
            <div id="wifiStatus" class="mt-3"></div>
        </div>

    </div>
    <!-- Notification container -->
    <div id="notification" class="notification"></div>
    <script defer src="/static/js/bootstrap.bundle.min.js"></script>
    <script>
        let fetchIntervalId;  // Declare a variable to store the interval ID
        let program_trigger = false;
        let elapsedTime = 0;  // Initialize elapsed time
        let elapsedTimeIntervalId;  // Declare a variable to store the elapsed time interval ID
        let processTimeGlobal;
        // Function to show notification
        function showNotification(message, duration = 3000, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;

            // Set the background color based on the type
            if (type === 'success') {
                notification.style.backgroundColor = '#4caf50'; // Green
            } else if (type === 'error') {
                notification.style.backgroundColor = '#f44336'; // Red
            }

            notification.classList.add('show');

            // Hide the notification after the specified duration
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        document.addEventListener('DOMContentLoaded', function () {


            fetch('/scan_wifi')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const ssidSelect = document.getElementById('ssid');
                        data.wifi_list.forEach(wifi => {
                            const option = document.createElement('option');
                            option.value = wifi.ssid;
                            option.textContent = wifi.ssid;
                            ssidSelect.appendChild(option);
                        });
                        showNotification('Scan Wi-Fi thành công!'); // Show custom notification
                    } else {
                        console.error('Failed to scan Wi-Fi networks:', data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
        });
        document.addEventListener('DOMContentLoaded', (event) => {
            // Fetch status when the page loads
            fetchStatus();
            const processTimeInput = document.getElementById('processTime');
            if (processTimeInput.value === null || processTimeInput.value === '') {
                processTimeInput.value = 1800; // Set a default value if null or empty
            }
        });
        let systemStatus = 'Đang chờ lệnh';  // Initialize system status globally

        function clearTableData() {
            console.log("clearTableData")
            const tableBody = document.getElementById('resultTable').querySelector('tbody');
            tableBody.innerHTML = ''; // Clear all rows in the table body
            document.getElementById('totalResultText').textContent = 'Chờ lệnh...'; // Reset the result text
            console.log("done clearTableData")
        }

        function clearGraphData() {
            console.log("clearGraphData")
            const graphDiv = document.getElementById('graph');
            if (graphDiv) {
                Plotly.purge(graphDiv); // Clear the graph data
            }
            console.log("done clearGraphData")
        }


        function clearImage() {
            console.log("clearImage")
            const latestImageElement = document.getElementById('latestImage');
            const hiddenImageElement = document.getElementById('hiddenImage');
            if (latestImageElement) {
                latestImageElement.src = './empty.jpg'; // Đặt lại hình ảnh mặc định hoặc để trống
            }
            if (hiddenImageElement) {
                hiddenImageElement.src = ''; // Xóa hình ảnh ẩn
            }
            console.log("done clearImage")
        }

        function resetElapsedTime() {
            elapsedTime = 0;  // Reset elapsed time to 0
            if (elapsedTimeIntervalId) {
                clearInterval(elapsedTimeIntervalId);  // Pause the elapsed time counter
                elapsedTimeIntervalId = null;
            }

            const elapsedTimeElement = document.getElementById('elapsed_time');
            console.log("restart elapsedTimeElement", elapsedTimeElement)
            if (elapsedTimeElement) {
                elapsedTimeElement.textContent = '0 s'; // Reset elapsed time to 0
            }
            console.log("done restart elapsedTimeElement", elapsedTimeElement)
        }

        function updateElapsedTime() {
            const elapsedTimeElement = document.getElementById('elapsed_time');
            if (elapsedTimeElement) {
                if (elapsedTime === null || elapsedTime === undefined) {
                    elapsedTimeElement.textContent = '0 s'; // Set a default value if null or undefined
                } else {
                    elapsedTimeElement.textContent = `${elapsedTime} s`;
                }
            }
        }

        function updateStatus(message) {
            const statusElement = document.getElementById('status');
            statusElement.innerText = `Trạng thái hiện tại: ${systemStatus} \n ${message}`;
        }

        function runProgram() {
            clearTableData();  // Clear the table before starting a new program
            const program = document.getElementById('programSelect').value;
            const temperature = document.getElementById('temperature').value;
            const checkTime = document.getElementById('checkTime').value;
            const processTime = document.getElementById('processTime').value;
            processTimeGlobal = processTime
            fetch('/run_program', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    program: program,
                    temperature: temperature,
                    checkTime: checkTime,
                    processTime: processTime
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Set program parameters, but keep the current system status
                        updateStatus(`Chương trình ${data.program_name} đã được thiết lập với:
                            T1: ${checkTime} giây
                            Thời gian chạy: ${processTime} giây
                            Nhiệt độ: ${temperature}°C`);

                    } else {
                        updateStatus(`Error: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    updateStatus('Failed to set program parameters.');
                });
        }


        function showMessage(message) {
            // alert(message);
            console.log(message)
        }

        function updateState(newState) {
            // Update the status on the page
            document.getElementById('status').innerText = `Trạng thái hiện tại: ${newState}`;

            // Save the status to the backend
            fetch('/status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: newState })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status !== 'success') {
                        console.error('Error updating status:', data);
                    }
                })
                .catch(error => console.error('Error updating status:', error));
        }

        function fetchStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    const statusElement = document.getElementById('status');

                    // Map program numbers to their names
                    const programNames = {
                        "1": "Làm quen quy trình",
                        "2": "Chạy mẫu thử"
                    };

                    // Get the program name based on the program number
                    const programName = programNames[data.program];

                    if (data.program !== null) {
                        statusElement.innerText = `
                                Trạng thái: ${data.status}
                                Chương trình ${data.program}: ${programName}
                                Thời gian T1: ${data.check_time_t1} giây
                                Thời gian chạy: ${data.process_time} giây
                                Nhiệt độ: ${data.temperature}°C
                            `;

                    } else {
                        statusElement.innerText = `Trạng thái: ${data.status}`;
                    }
                })
                .catch(error => console.error('Error fetching status:', error));
        }



        function changeState(newState, actionFunc) {
            updateState(newState);
            actionFunc().then(response => {
                if (response.ok) {
                    showMessage("SYSTEM IS " + newState);
                } else {
                    showMessage("SYSTEM ERROR: " + newState);
                }
            }).catch(error => {
                showMessage("SYSTEM ERROR: " + error.message);
            });
        }


        let isSettingTemperature = false;

        // Unified fetch function that replaces all individual fetches
        function fetchAllData() {
            fetch('/fetch_all_data')
                .then(response => response.json())
                .then(data => {
                    // Update temperature data
                    const tempElement = document.getElementById('temp_value');
                    const setpointElement = document.getElementById('setpoint_value');
                    const outputElement = document.getElementById('output_value');

                    // Xử lý tempElement
                    if (tempElement) {
                        if (data.temperature && typeof data.temperature.temperature === 'number') {
                            tempElement.textContent = data.temperature.temperature.toFixed(1);
                            console.log("tempElement", tempElement);
                        } else {
                            tempElement.textContent = 'N/A';
                        }
                    }

                    // Xử lý setpointElement
                    if (setpointElement) {
                        if (data.temperature && typeof data.temperature.setpoint === 'number') {
                            setpointElement.textContent = data.temperature.setpoint.toFixed(1);
                        } else {
                            setpointElement.textContent = 'N/A';
                        }
                    }

                    // Xử lý outputElement
                    if (outputElement) {
                        if (data.temperature && typeof data.temperature.output === 'number') {
                            outputElement.textContent = data.temperature.output.toFixed(1);
                        } else {
                            outputElement.textContent = 'N/A';
                        }
                    }
                    program_trigger = data.program_trigger
                    // Update program result
                    const totalResultTextElement = document.getElementById('totalResultText');
                    const resultTableBody = document.getElementById('resultTable') ? document.getElementById('resultTable').querySelector('tbody') : null;
                    if (totalResultTextElement && resultTableBody && data.program_result && data.program_result.table_data) {
                        totalResultTextElement.textContent = data.program_result.total_result || 'Waiting for result...';

                        // Clear the table body before updating
                        resultTableBody.innerHTML = '';

                        // Populate the table with the updated data
                        data.program_result.table_data.forEach(row => {
                            console.log("row is", row)
                            const tr = document.createElement('tr');

                            // Apply color based on the result
                            if (row.Result === "Dương tính") {
                                console.log("Dương tính")
                                tr.innerHTML = `
                                <td style="color: #e74c3c;">${row.Tube}</td>
                                <td style="color: #e74c3c;">${typeof row['Hue Value'] === 'number' ? row['Hue Value'].toFixed(2) : 'N/A'}</td>
                                <td style="color: #e74c3c;">${typeof row['C Value'] === 'number' ? row['C Value'].toFixed(2) : 'N/A'}</td>
                                <td style="color: #e74c3c;">${row.Result}</td>
                            `;
                            } else if (row.Result === "Âm tính") {
                                console.log("Âm tính")
                                tr.innerHTML = `
                                <td style="color: #50b2dc;">${row.Tube}</td>
                                <td style="color: #50b2dc;">${typeof row['Hue Value'] === 'number' ? row['Hue Value'].toFixed(2) : 'N/A'}</td>
                                <td style="color: #50b2dc;">${typeof row['C Value'] === 'number' ? row['C Value'].toFixed(2) : 'N/A'}</td>
                                <td style="color: #50b2dc;">${row.Result}</td>
                            `;
                            } else {
                                console.log("không tính")
                                tr.innerHTML = `
                                <td >${row.Tube}</td>
                                <td >${typeof row['Hue Value'] === 'number' ? row['Hue Value'].toFixed(2) : 'N/A'}</td>
                                <td >${typeof row['C Value'] === 'number' ? row['C Value'].toFixed(2) : 'N/A'}</td>
                                <td >${row.Result}</td>`
                            }

                            resultTableBody.appendChild(tr);
                        });
                    }

                    // Update elapsed time
                    if (!elapsedTimeIntervalId && data.program_trigger) {
                        // console.log("khởi động lại elapsedTimeIntervalId", elapsedTimeIntervalId)
                        elapsedTime = Math.floor(data.elapsed_time)
                        // const elapsedTimeElement = document.getElementById('elapsed_time');
                        // if (elapsedTimeElement && data.elapsed_time !== undefined) {
                        //     elapsedTimeElement.textContent = `${ Math.floor(elapsedTime) } s`;
                        // }
                        elapsedTimeIntervalId = setInterval(() => {
                            elapsedTime++;
                            updateElapsedTime();
                        }, 1000);  // Resume the elapsed time counter

                    }
                    // else if (!data.program_trigger) {
                    //     if (elapsedTimeIntervalId) {
                    //         clearInterval(elapsedTimeIntervalId);  // Pause the elapsed time counter
                    //         elapsedTimeIntervalId = null;
                    //         elapsedTime = 0;  // Reset elapsed time to 0
                    //     }
                    // }
                    else {
                        console.log("elapsedTimeIntervalId đã có", elapsedTimeIntervalId)
                    }
                    processTimeGlobal = data.process_time
                    console.log("elapsedTime", elapsedTime)
                    console.log("processTime", processTimeGlobal)
                    console.log("data.process_time", data.process_time)

                    if (elapsedTime >= processTimeGlobal) {
                        clearInterval(elapsedTimeIntervalId);  // Pause the elapsed time counter
                        elapsedTimeIntervalId = null;
                        elapsedTime = processTimeGlobal;  // Reset elapsed time to 0
                        updateElapsedTime()
                    }


                    // // Update image
                    // const latestImageElement = document.getElementById('latestImage');
                    // if (latestImageElement && data.image_url) {
                    //     latestImageElement.src = data.image_url;
                    // }

                    // Update image
                    const latestImageElement = document.getElementById('latestImage');
                    const hiddenImageElement = document.getElementById('hiddenImage');
                    if (hiddenImageElement && data.image_url) {
                        hiddenImageElement.src = data.image_url;
                        hiddenImageElement.onload = () => {
                            latestImageElement.src = data.image_url;
                        };
                    }

                    // Update plot data using Plotly
                    const graphDiv = document.getElementById('graph');
                    if (graphDiv && data.plot_data && data.plot_data.data && data.plot_data.layout) {
                        Plotly.react(graphDiv, data.plot_data.data, data.plot_data.layout);
                    }
                })
                .catch(error => console.error('Error fetching all data:', error));
        }




        // function startCapture() {
        //     clearTableData();  // Clear the table before starting a new program
        //     fetch('/start')
        //         .then(response => response.json())
        //         .then(data => {
        //             systemStatus = 'Đang chạy';
        //             updateStatus('Thiết bị đã hoạt động.');
        //         })
        //         .catch(error => {
        //             updateStatus('Không thể khởi động hệ thống.');
        //             console.error('Lỗi:', error);
        //         });
        // }

        async function startCapture() {
            clearTableData();  // Clear the table before starting a new program
            try {
                let response = await fetch('/start');
                let data = await response.json();
                systemStatus = 'Đang chạy';
                updateStatus('Thiết bị đã hoạt động.');

                // Run the program after starting the capture
                await runProgram();

                // // Start the interval to fetch data every 1 second
                // setInterval(fetchAllData, 1000);
                // Check if the interval is already set, if not, set it
                console.log("disme", fetchIntervalId)
                if (!fetchIntervalId) {
                    fetchIntervalId = setInterval(fetchAllData, 3000);  // Set interval to 10 seconds
                }

                // Start the elapsed time counter
                if (!elapsedTimeIntervalId) {
                    elapsedTimeIntervalId = setInterval(() => {
                        elapsedTime++;
                        updateElapsedTime();
                    }, 1000);  // Update elapsed time every second
                }
                program_trigger = true
                return data;
            } catch (error) {
                updateStatus('Không thể khởi động hệ thống.');
                console.error('Lỗi:', error);
            }
        }

        function pauseCapture() {
            fetch('/pause')
                .then(response => response.json())
                .then(data => {
                    systemStatus = 'Tạm dừng';
                    updateStatus('Thiết bị tạm dừng.');
                    clearInterval(elapsedTimeIntervalId);  // Pause the elapsed time counter
                    elapsedTimeIntervalId = null;
                })
                .catch(error => {
                    updateStatus('Không thể tạm dừng hệ thống.');
                    console.error('Lỗi:', error);
                });
        }

        function resumeCapture() {
            fetch('/resume')
                .then(response => response.json())
                .then(data => {
                    systemStatus = 'Tiếp tục';
                    updateStatus('Thiết bị tiếp tục chạy.');
                    if (!elapsedTimeIntervalId) {
                        elapsedTimeIntervalId = setInterval(() => {
                            elapsedTime++;
                            updateElapsedTime();
                        }, 1000);  // Resume the elapsed time counter
                    }
                })
                .catch(error => {
                    updateStatus('Không thể tiếp tục hệ thống.');
                    console.error('Lỗi:', error);
                });
        }

        // function resetCapture() {
        //     clearTableData();  // Clear the table before starting a new program
        //     fetch('/reset')
        //         .then(response => response.json())
        //         .then(data => {
        //             systemStatus = 'Reset';
        //             updateStatus('System reset.');
        //         })
        //         .catch(error => {
        //             updateStatus('Failed to reset system.');
        //             console.error('Error:', error);
        //         });
        // }

        async function resetCapture() {
            console.log("resetCapture")
            let data;
            try {
                const response = await fetch('/reset');
                data = await response.json();
                systemStatus = 'Reset';
                updateStatus('System reset.');
                // Clear the interval after reset if it exists
                if (fetchIntervalId) {
                    clearInterval(fetchIntervalId);
                    fetchIntervalId = null;  // Reset the interval ID
                }
                program_trigger = false
            } catch (error) {
                updateStatus('Failed to reset system.');
                console.error('Error:', error);
            }
            clearTableData();  // Clear the table before starting a new program
            clearGraphData();  // Clear the graph data
            resetElapsedTime(); // Reset elapsed time to 0
            clearImage(); // Xóa hình ảnh
            return data

        }

        function downloadCSV() {
            window.location.href = '/download_CSV';
        }

        function downloadImages() {
            window.location.href = '/download';
        }



        function setTemperature() {
            const temperature = document.getElementById('setTemperature').value;
            isSettingTemperature = true;

            fetch('/set_temperature', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: 'value=' + temperature
            })
                .then(response => response.json())
                .then(data => {
                    isSettingTemperature = false;
                    if (data.response === 'OK') {
                        alert('Temperature set successfully');
                    } else {
                        alert('Failed to set temperature');
                    }
                })
                .catch(error => {
                    isSettingTemperature = false;
                    console.error('Error setting temperature:', error);
                    alert('Error setting temperature');
                });
        }




        fetchIntervalId = setInterval(fetchAllData, 3000);

        // Initial data fetch when the page loads
        fetchAllData();

        document.getElementById('wifiForm').addEventListener('submit', function (event) {
            event.preventDefault();
            const ssid = document.getElementById('ssid').value;
            const password = document.getElementById('password').value;

            // Set a timeout to reload the page after 10 seconds
            const timeoutId = setTimeout(() => {
                showNotification('Chuẩn bị restart lại web', 3000, 'error');
                setTimeout(() => {
                    location.reload();
                }, 2000); // Wait 2 seconds before reloading
            }, 10000); // 10 seconds

            fetch('/setup_wifi', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ ssid: ssid, password: password })
            })
                .then(response => response.json())
                .then(data => {
                    clearTimeout(timeoutId); // Clear the timeout if the request completes
                    let wifiError = data.error ? ` ${data.error}` : ''
                    if (data.status === 'success') {
                        showNotification('WiFi đã được thiết lập thành công!', 3000);
                    } else {
                        showNotification('Thiết lập WiFi thất bại: ' + data.message + wifiError, 3000, 'error');
                    }
                })
                .catch(error => {
                    clearTimeout(timeoutId); // Clear the timeout if the request completes
                    console.error('Error:', error);
                    showNotification('Thiết lập WiFi thất bại.', 3000, 'error');
                });
        });

    </script>
</body>

</html>