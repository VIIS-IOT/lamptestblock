
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testtube LAMP</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="/static/css/bootstrap-theme.min.css">
    <script src="/static/js/plotly.min.js"></script>

    <style>
        body {
            padding: 20px;
        }

        .section-divider {
            margin-top: 20px;
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f8f9fa;
        }

        #latestImage {
            max-width: 100%;
            height: auto;
            align-items: center;
        }

        .graph-container {
            width: 100%;
            margin-top: 20px;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
        }

        .graph {
            width: 100%;
        }

        h2 {
            margin-top: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        h3 {
            margin-top: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        #status {
            margin-top: 20px;
            margin-bottom: 20px;
            padding: 10px;
            font-weight: bold;
            text-align: center;
            border: 2px solid #f5b861;
            background-color: #f8f9fa;
        }
    </style>
    
</head>

<body>
    <div class="container">
        <h1 class="mb-4 text-center">LAMP: HUE color value extract from test tube </h1>
        
        <!-- Button Group -->
        <div class="section-divider">
            <div id="controls" class="d-flex flex-wrap justify-content-center">
                <button class="btn btn-primary" onclick="changeState('Running', startCapture)">Start</button>
                <button class="btn btn-warning" onclick="changeState('Pause', pauseCapture)">Pause</button>
                <button class="btn btn-success" onclick="changeState('Resume', resumeCapture)">Resume</button>
                <button class="btn btn-danger" onclick="changeState('Reset', resetCapture)">Reset</button>
                <button class="btn btn-info" onclick="changeState('Downloading CSV', downloadCSV)">Download CSV</button>
                <button class="btn btn-info" onclick="changeState('Downloading Image', downloadImages)">Download Images</button>
            </div>
        </div>
        <div id="status">CURRENT STATUS: Waiting for command</div>
        <!-- Program and Temperature Settings -->
        <div class="section-divider">
            <div id="controls" class="d-flex flex-wrap justify-content-center">
                <div class="input-group mb-3">
                    <label for="programSelect" class="input-group-text">Program:</label>
                    <select id="programSelect" class="form-select">
                        <option value="1">1: Familiarization Process</option>
                        <option value="2">2: Run Sample Check</option>
                    </select>
                </div>

                <div class="input-group mb-3">
                    <label for="temperature" class="input-group-text">Set temperature (C):</label>
                    <input type="number" id="temperature" class="form-control" value="25">
                </div>

                <div class="input-group mb-3">
                    <label for="checkTime" class="input-group-text">Set check time T1 (s):</label>
                    <input type="number" id="checkTime" class="form-control" value="900">
                </div>

                <div class="input-group mb-3">
                    <label for="processTime" class="input-group-text">Set process time (s):</label>
                    <input type="number" id="processTime" class="form-control" value="1800">
                </div>

                <button class="btn btn-primary" onclick="runProgram()">Run program</button>
            </div>
        </div>

        <!-- Result Display -->
        <div class="section-divider">
            <div id="result">
                <h4>Elapsed time: <span id="elapsed_time"> s</span></h4>
                <h4>Result: <span id="totalResultText">Waiting for result...</span></h4>
                
                <table id="resultTable" class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Tube</th>
                            <th>Hue Value</th> <!-- New Column for Hue Values -->
                            <th>C Value</th>
                            <th>Result of Tube</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be dynamically inserted here -->
                    </tbody>
                </table>
                
            </div>
        </div>

        

        <!-- Plot and Image Display -->
        <div class="section-divider">
            <div class="row">
                <div class="col-12 col-md-3">
                    <h3>Latest Captured Image </h3>
                    <img id="latestImage" src="" alt="Latest Image" class="img-fluid" />
        </div>
        <div class="section-divider">
            <div>
                <h3>Test tube temperature</h3>
                <div id="temperature_values">
                    <p>Value: <span id="temp_value">-</span> 째C</p>
                    <p>Setpoint: <span id="setpoint_value">-</span> 째C</p>
                    <p>Control: <span id="output_value">-</span></p>
                </div>
                <div class="input-group mb-3">
                    <label for="setTemperature" class="input-group-text">New Setpoint:</label>
                    <input type="number" id="setTemperature" class="form-control" min="0" step="1" value="25">
                    <div class="input-group-append">
                        <button class="btn btn-secondary" onclick="setTemperature()">Update</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="section-divider">  
                <div style="margin-top: 2rem;" class="col-12 col-md-9 ">
                    <h3>HUE Color Value Plot </h3>
                    <div class="graph graph-container" id="graph"></div>
                </div>
        </div>
        

    </div>

    <script defer src="/static/js/bootstrap.bundle.min.js"></script>
    <script>
        // Your JavaScript functions will be here
    </script>
</body>

</html>

    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            // Fetch status when the page loads
            fetchStatus();
        });
        function runProgram() {
            const program = document.getElementById('programSelect').value;
            const temperature = document.getElementById('temperature').value;
            const checkTime = document.getElementById('checkTime').value;
            const processTime = document.getElementById('processTime').value;

            // Map program numbers to their names
            const programNames = {
                "1": "Familiarization Process",
                "2": "Run Sample Check",
                "3": "Kit Review"
            };

            const programName = programNames[program];

            fetch('/run_program', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    program: program,
                    temperature: temperature,
                    checkTime: checkTime,
                    processTime: processTime
                })
            })
            .then(response => response.json())
            .then(data => {
                // Update the status display immediately
                const statusElement = document.getElementById('status');
                statusElement.innerText = `
                    Current status: Running
                    Program ${program}: ${programName}
                    Check Time T1: ${checkTime} seconds
                    Process Time: ${processTime} seconds
                    Temperature: ${temperature}째C
                `;
            })
            .catch(error => console.error('Error:', error));
        }



        


        function showMessage(message) {
            alert(message);
        }

        function updateState(newState) {
             // Update the status on the page
             document.getElementById('status').innerText = `Current status: ${newState}`;
            
            // Save the status to the backend
            fetch('/status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: newState })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status !== 'success') {
                    console.error('Error updating status:', data);
                }
            })
            .catch(error => console.error('Error updating status:', error));
        }

        function fetchStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    const statusElement = document.getElementById('status');

                    // Map program numbers to their names
                    const programNames = {
                        "1": "Familiarization Process",
                        "2": "Run Sample Check",
                        "3": "Kit Review"
                    };

                    // Get the program name based on the program number
                    const programName = programNames[data.program];

                    if (data.program !== null) {
                        statusElement.innerText = `
                            Current status: ${data.status}
                            Program ${data.program}: ${programName}
                            Check Time T1: ${data.check_time_t1} seconds
                            Process Time: ${data.process_time} seconds
                            Temperature: ${data.temperature}째C
                        `;
                    } else {
                        statusElement.innerText = `Current status: ${data.status}`;
                    }
                })
                .catch(error => console.error('Error fetching status:', error));
        }



        function changeState(newState, actionFunc) {
            updateState(newState);
            actionFunc().then(response => {
                if (response.ok) {
                    showMessage("SYSTEM IS " + newState);
                } else {
                    showMessage("SYSTEM ERROR: " + newState);
                }
            }).catch(error => {
                showMessage("SYSTEM ERROR: " + error.message);
            });
        }
        function fetchData() {
                var columns = window.innerWidth < 768 ? 1 : 2;  // 1 column for small screens, 2 columns for larger screens
                fetch(`/plot/${columns}`)
                    .then(response => response.json())
                    .then(data => {
                        var graphDiv = document.getElementById('graph');
                        Plotly.react(graphDiv, JSON.parse(data).data, JSON.parse(data).layout);
                });
        }

        function fetchLatestImage() {
            var img = document.getElementById('latestImage');
            img.src = '/latest_image?' + new Date().getTime();
        }

        let isSettingTemperature = false;

        function fetchTemperatureData() {
            if (isSettingTemperature) return;

            fetch('/temperature')
            .then(response => response.json())
            .then(data => {
                const tempValue = document.getElementById('temp_value');
                const setpointValue = document.getElementById('setpoint_value');
                const outputValue = document.getElementById('output_value');

                if (data) {
                tempValue.textContent = data.temperature.toFixed(1);
                setpointValue.textContent = data.setpoint.toFixed(1);
                outputValue.textContent = data.output.toFixed(1);
                } else {
                tempValue.textContent = 'No data';
                setpointValue.textContent = 'No data';
                outputValue.textContent = 'No data';
                }
            })
            .catch(error => {
                console.error('Error fetching temperature data:', error);
                const tempValue = document.getElementById('temp_value');
                const setpointValue = document.getElementById('setpoint_value');
                const outputValue = document.getElementById('output_value');
                tempValue.textContent = 'Error';
                setpointValue.textContent = 'Error';
                outputValue.textContent = 'Error';
            });
        }
        function fetchProgramResult() {
    fetch('/get_program_result')
        .then(response => response.json())
        .then(data => {
            // Update total result text for the program
            if (data.total_result) {
                document.getElementById('totalResultText').textContent = data.total_result;
            } else {
                document.getElementById('totalResultText').textContent = "Waiting for result...";
            }

            // Clear the table body
            const tableBody = document.getElementById('resultTable').querySelector('tbody');
            tableBody.innerHTML = '';

            // Populate the table with the table_data, including the Hue Value
            if (data.table_data) {
                data.table_data.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${row.Tube}</td>
                        <td>${typeof row['Hue Value'] === 'number' ? row['Hue Value'].toFixed(2) : 'N/A'}</td>
                        <td>${typeof row['C Value'] === 'number' ? row['C Value'].toFixed(2) : 'N/A'}</td>
                        <td>${row.Result}</td>
                    `;
                    tableBody.appendChild(tr);
                });
            }
        })
        .catch(error => console.error('Error fetching program result:', error));
}


        function fetchElapsedTime() {
            fetch('/elapsed_time')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('elapsed_time').textContent = `${Math.floor(data.elapsed_time)} s`;
                })
                .catch(error => console.error('Error fetching elapsed time:', error));
        }







        function startCapture() {
            fetch('/start')
                //.then(response => response.json())
                //.then(data => console.log(data));
                //changeState('Running', startCapture);
        }

        function pauseCapture() {
            fetch('/pause')
                //.then(response => response.json())
                //.then(data => console.log(data));
                //changeState('Pause', pauseCapture);
        }

        function resumeCapture() {
            fetch('/resume')
                //.then(response => response.json())
                //.then(data => console.log(data));
                //changeState('Resume', resumeCapture);
        }

        function resetCapture() {
            fetch('/reset')
                //.then(response => response.json())
                //.then(data => console.log(data));
                //changeState('Reset', resetCapture);
        }

        function downloadCSV() {
            window.location.href = '/download_CSV';
            //changeState('Downloading CSV', downloadCSV);
        }

        function downloadImages() {
            window.location.href = '/download';
            //changeState('Downloading Image', downloadImages);
        }

        function set_Interval() {
            var interval = document.getElementById('interval').value;
            
            fetch('/set_interval', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: 'interval=' + interval
            })
                .then(response => response.json())
                .then(data => console.log(data));
        }

        function setTemperature() {
            const temperature = document.getElementById('setTemperature').value;
            isSettingTemperature = true;

            fetch('/set_temperature', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: 'value=' + temperature
            })
            .then(response => response.json())
            .then(data => {
                isSettingTemperature = false;
                if (data.response === 'OK') {
                alert('Temperature set successfully');
                } else {
                alert('Failed to set temperature');
                }
            })
            .catch(error => {
                isSettingTemperature = false;
                console.error('Error setting temperature:', error);
                alert('Error setting temperature');
            });
        }

        

        setInterval(fetchData, 5000);
        setInterval(fetchLatestImage, 5000);
        setInterval(fetchTemperatureData, 5000);
        // Call fetchProgramResult every few seconds
        setInterval(fetchProgramResult, 5000);
        // Call fetchElapsedTime every second
        setInterval(fetchElapsedTime, 1000);
        fetchData();
        fetchLatestImage();
        fetchTemperatureData();
        fetchProgramResult();
        
    </script>
    <script defer src="/static/js/bootstrap.bundle.min.js"></script>

</body>

</html>   
